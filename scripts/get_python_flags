#!/bin/bash

if [ -z "${MESON_SOURCE_ROOT}" ]; then
  echo "[ERROR] This script can only be ran with meson!"
  exit 1
fi

cd "${MESON_SOURCE_ROOT}"

if [[ -n "$BTLLIB_PYTHON_CFLAGS" ]]; then
  cflags=$BTLLIB_PYTHON_CFLAGS
  ldflags=$BTLLIB_PYTHON_LDFLAGS
else
  cflags=$(python3-config --cflags)
  ldflags=$(python3-config --ldflags)
fi

found_libpython=false
for flag in $ldflags; do
  if [[ $flag == "-lpython"* ]]; then
    found_libpython=true
  fi
done

if [[ $found_libpython == false ]]; then
  if [[ -n "$BTLLIB_PYTHON_VERSION" ]]; then
    py_version="python$BTLLIB_PYTHON_VERSION"
  else
    py_version=python$(python3 --version | awk '{print $2}' | awk -F '.' '{print $1 "." $2}')
  fi
  ld ${ldflags} -l${py_version} -o btllib_py_lib_check.tmp
  if [[ $? -eq 0 ]]; then
    libpythonflag="-l${py_version}"
  else
    libpythonflag="-l${py_version}m"
  fi
  rm -f btllib_py_lib_check.tmp
  ldflags+=$libpythonflag
fi

echo "$cflags"
echo "$ldflags"